# Source:
# https://github.com/Jorre05/micronova
# https://discord.com/channels/1074689465236336680/1074695224774901852
# Discord channel micronova controller


substitutions:
  friendly_name: "micronova-n100"
  friendly_name_wifiap: "micronova-n100-Hotspot"
  reboot_time: "300min"
  hostname: "micronova-n100"

esphome:
  name: micronova-n100
  friendly_name: micronova-n100

esp32:
  board: az-delivery-devkit-v4
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "QWxpY2UncyBBZHZlbnr23rwaeffsdf55-wer"
    
ota:
  - platform: esphome
    id: my_ota
    password: "sfewatreASDf0wer"

wifi:
  networks:
  - ssid: !secret wifi_ssid
    password: !secret wifi_password
  reboot_timeout : ${reboot_time} #reboot si pas de wifi actif
    # Enable fallback hotspot (captive portal) in case wifi connection fails
# Optional manual IP
  manual_ip:
    static_ip: !secret static_ip_stove
    gateway: !secret gateway
    subnet: !secret subnet
  ap:
    ssid: "${friendly_name}"
    password: k@shitonsflow3r

uart:
  - id: my_uart
    rx_pin: 
      number: GPIO25
      mode: 
        input: true
        pullup: true
    tx_pin:
      number: GPIO26
    baud_rate: 1200
    stop_bits: 2 

external_components:
  - source: github://Jorre05/micronova
    components: [ micronova ]

micronova:
  enable_rx_pin: GPIO27
  update_interval: 60s

text_sensor:
  - platform: micronova
    stove_state:
      name: Status

number:
  - platform: micronova
    thermostat_temperature:
        name: Termostato
        id: micronova_thermostat
        step: 0.5
        on_value:
          then:
            - lambda: |-
                if ( id(ha_thermostat).target_temperature != id(micronova_thermostat).state ) {
                  auto call = id(ha_thermostat).make_call();
                  call.set_target_temperature(id(micronova_thermostat).state);
                  call.perform();
                }
    power_level:
      name: Power level
      max_value: 5
    

sensor:
  - platform: micronova
    room_temperature:
      name: "Temp salon"
      id: micronova_room_temperature
    fumes_temperature:
      name: "Temp Humo"
    stove_power:
      name: "Power level"
    fan_speed:
      fan_rpm_offset: 240
      name: "Fan RPM"
    water_temperature:
      name: "Water temperature"
    water_pressure:
      name: "Water pressure"
    memory_address_sensor:
      memory_location: 0x20
      memory_address: 0x7d
      name: "Custom Addres sensor"

  - platform: micronova
    memory_address_sensor:
      name: "Address 0x5A"
      id: c1_id
      memory_location: 0x00
      memory_address: 0x5A
  - platform: micronova
    memory_address_sensor:
      name: "Address 0x34"
      id: c2_id
      memory_location: 0x00
      memory_address: 0x34
    room_temperature:
      name: "Kamertemperatuur"
      id: kamertemperatuur
      accuracy_decimals: 2
      filters:
        - sliding_window_moving_average:
            window_size: 20
            send_every: 1
            send_first_at: 1

switch:
   - platform: micronova
     stove:
      name: "Stove on/off"
      id: stove_switch
      on_turn_on:
        - lambda: |-
            if ( id(ha_thermostat).mode != CLIMATE_MODE_HEAT ) {
              auto call = id(ha_thermostat).make_call();
              call.set_mode("HEAT");
              call.perform();
            }
      on_turn_off:
        - lambda: |-
            if ( id(ha_thermostat).mode != CLIMATE_MODE_OFF ) {
              auto call = id(ha_thermostat).make_call();
              call.set_mode("OFF");
              call.perform();
            }

button:
  - platform: micronova
    custom_button:
      name: "Custom button"
      memory_location: 0x20
      memory_address: 0x7d
      memory_data: 0x08

climate:
  - platform: thermostat
    name: "Termostato"
    id: ha_thermostat
    sensor: micronova_room_temperature
    min_idle_time: 0s
    min_heating_off_time: 0s
    min_heating_run_time: 0s
    default_preset: Startup preset
    on_boot_restore_from: DEFAULT_PRESET
    preset:
      - name: "Startup preset"
        default_target_temperature_low: 20
    visual:
      min_temperature: 17 °C
      max_temperature: 22 °C
      temperature_step:
        target_temperature: 0.5
        current_temperature: 0.5
    idle_action:
      - lambda: |-
          ESP_LOGD("main","Bogus idle action");
    heat_action:
      - lambda: |-
          ESP_LOGD("main","Bogus heat action");
    heat_mode:
      - lambda: |-
          if ( ! id(stove_switch).state ) {
            id(stove_switch).turn_on();
          }
    off_mode:
      - lambda: |-
          if ( id(stove_switch).state ) {
            id(stove_switch).turn_off();
          }
    target_temperature_change_action:
       - lambda: |-
           if ( id(ha_thermostat).target_temperature != id(micronova_thermostat).state ) {
             auto call = id(micronova_thermostat).make_call();
             call.set_value(id(ha_thermostat).target_temperature);
             call.perform();
           }
